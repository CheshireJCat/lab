<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>three.js webgl - loaders - MMD loader</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style type="text/css">
    body {
        margin: 0;
    }
    </style>
</head>

<body data-pinterest-extension-installed="cr1.39.2">
    <script src="//cdn.bootcss.com/three.js/r79/three.min.js"></script>
    <script src="//ob0qcsukh.bkt.clouddn.com/canvas/mmd2/js/charsetencoder.min.js"></script>
    <script src="//ob0qcsukh.bkt.clouddn.com/canvas/mmd2/js/ammo.js"></script>
    <script src="//ob0qcsukh.bkt.clouddn.com/canvas/mmd2/js/TGALoader.js"></script>
    <script src="//ob0qcsukh.bkt.clouddn.com/canvas/mmd2/js/MMDLoader.js"></script>
    <script src="//ob0qcsukh.bkt.clouddn.com/canvas/mmd2/js/CCDIKSolver.js"></script>
    <script src="//ob0qcsukh.bkt.clouddn.com/canvas/mmd2/js/MMDPhysics.js"></script>
    <script src="//ob0qcsukh.bkt.clouddn.com/canvas/mmd2/js/Detector.js"></script>
    <script src="//cdn.bootcss.com/stats.js/r16/Stats.min.js"></script>
    <script src="//cdn.bootcss.com/dat-gui/0.5.1/dat.gui.min.js"></script>
    <script>
    var mmd = (function() {
    var container, stats;

    var mesh, camera, scene, renderer;
    var helper;

    var ready = false;

    var mouseX = 0,
        mouseY = 0;

    var windowHalfX = window.innerWidth / 2;
    var windowHalfY = window.innerHeight / 2;

    var clock = new THREE.Clock();

    var animate = function() {
        requestAnimationFrame(animate);
        render();
    };
    //stat fps listen
    stats = new Stats();
    stats.setMode(0);
    stats.domElement.style.position = 'fixed';
    stats.domElement.style.left = '0px';
    stats.domElement.style.bottom = '0px';
    stats.domElement.style.top = 'auto';
    document.body.appendChild(stats.domElement);

    var fontLink = 'http://ob0qcsukh.bkt.clouddn.com/canvas/mmd2/';
    var op = {
        ambientColor: '#454545',
        directionalLightColor: '#CCCCCC',
        modelFile: {
            tda: fontLink+'models/role/mikuTheWorldIsMime/1.pmd',
            sms: fontLink+'models/role/miku9/1.pmx',
            kizunaai: fontLink+'models/role/kizunaai/kizunaai.pmx',
        },
        vmdFiles: {
            elysion: [fontLink+'models/vmd/elysion2.vmd'],
            snow: [fontLink+'models/vmd/snow.vmd']
        },
        cameraFiles: {
            elysion: [fontLink+'models/vmd/camera1.vmd']
        },
        audioFile: {
            elysion: fontLink+'models/audio/elysion.mp3',
            LoveSnowRealMagic: fontLink+'models/audio/LoveSnowRealMagic.mp3'
        },
        container: 'mmd-container'
    };

    init();
    animate();

    var ambient;
    var plane;
    var directionalLight;

    function createStage() {
        if (document.getElementById(op.container)) {
            return false;
        }
        //create div
        container = document.createElement('div');
        container.id = op.container;
        if (!document.getElementById(container.id)) document.body.appendChild(container);

        //create camera
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 2000);

        //create scene
        scene = new THREE.Scene();
        //create ambient light - 环境光
        ambient = new THREE.AmbientLight(op.ambientColor);
        scene.add(ambient);

        //create directionalLight -平行光
        directionalLight = new THREE.DirectionalLight(op.directionalLightColor);
        directionalLight.position.set(-1, 1, 1).normalize();
        scene.add(directionalLight);

        //create plane - 创建场地
        var geometry = new THREE.PlaneBufferGeometry(200, 200, 40, 40);
        var material = new THREE.MeshLambertMaterial({
            color: 0xa0becd,
            wireframe: true
        });
        plane = new THREE.Mesh(geometry, material);
        plane.position.y = 0;
        plane.rotation.x = -Math.PI / 2;
        plane.receiveShadow = true;
        scene.add(plane);

        //渲染
        renderer = new THREE.WebGLRenderer();
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(new THREE.Color(0x000000));
        if (!container.getElementsByTagName('canvas')[0]) container.appendChild(renderer.domElement);
    }

    function changeLight(_op) {
        directionalLight.color.set(_op && _op.directionalLightColor || op.directionalLightColor);
        ambient.color.set(_op && _op.ambientColor || op.ambientColor);
    }

    function init(_op) {
        createStage();
        changeLight(_op);

        //模型载入进度
        function progressF(id) {
            return function(xhr) {
                if (xhr.lengthComputable) {
                    var percentComplete = xhr.loaded / xhr.total * 100;
                    document.getElementById(id).innerHTML = Math.round(percentComplete, 2) + '% downloaded';
                }
            };
        }

        function onError(id, path) {
            return function(xhr) {
                console.log(id, path);
            };
        }

        var modelFile = _op && _op.modelFile || op.modelFile.kizunaai;
        var vmdFiles = _op && _op.vmdFiles || op.vmdFiles.elysion;
        vmdFiles = vmdFiles.slice();
        if (typeof vmdFiles == 'string') {
            vmdFiles = [vmdFiles]
        }
        var audioFile = _op && _op.audioFile || op.audioFile.elysion;
        var cameraFiles = _op && _op.cameraFiles || op.cameraFiles.elysion;
        cameraFiles = cameraFiles.slice();
        if (typeof cameraFiles == 'string') {
            cameraFiles = [cameraFiles]
        }
        var audioParams = {
            delayTime: 0,
            autoplay: false
        };

        //mmd 助手
        helper = new THREE.MMDHelper(renderer);

        var loader = new THREE.MMDLoader();
        //loader.setDefaultTexturePath(fontLink+'models/default/');

        loader.loadAudio(audioFile, function(audio, listener) {

            listener.position.z = 1;
            helper.setAudio(audio, listener, audioParams);
            helper.unifyAnimationDuration();

            audio.name = 'audio';
            listener.name = 'listener';

            scene.add(audio);
            scene.add(listener);

            loader.load(modelFile, vmdFiles, function(object) {
                mesh = object;
                mesh.name = 'mesh';
                helper.add(mesh);
                scene.add(mesh);
                helper.setAnimation(mesh);
                if (!isMobileDevice()) {
                    helper.setPhysics(mesh);
                }

                loader.loadVmds(cameraFiles, function(vmd) {

                    helper.setCamera(camera);
                    loader.pourVmdIntoCamera(camera, vmd);
                    helper.setCameraAnimation(camera);
                    canPlay(_op);

                }, progressF('camera'), onError('camera', cameraFiles));
            }, progressF('model'), onError('model', [modelFile, vmdFiles]));
        }, progressF('audio'), onError('audio', audioFile));

        document.addEventListener('mousemove', onDocumentMouseMove, false);
        window.addEventListener('resize', onWindowResize, false);
    }

    function canPlay(_op) {
        ready = true;
        document.getElementById('audio').innerHTML = '';
        document.getElementById('camera').innerHTML = '';
        document.getElementById('model').innerHTML = '';

        if (_op && _op.callback && typeof _op.callback == 'function') {
            _op.callback();
        }
    }

    function remove(name) {
        scene.remove(scene.getObjectByName(name))
    }

    function onWindowResize() {

        windowHalfX = window.innerWidth / 2;
        windowHalfY = window.innerHeight / 2;

        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize(window.innerWidth, window.innerHeight);

    }

    function onDocumentMouseMove(event) {

        mouseX = (event.clientX - windowHalfX) / 2;
        mouseY = (event.clientY - windowHalfY) / 2;

    }

    function render() {

        if (ready) {
            var delta = clock.getDelta();
            helper.animate(delta);
            helper.render(scene, camera);
            stats.update();
        } else {
            window.cancelAnimationFrame(animate);
            renderer.clear();
            renderer.render(scene, camera);
        }
    }

    // easy mobile device detection
    function isMobileDevice() {

        if (navigator === undefined || navigator.userAgent === undefined) {
            return true;
        }

        var s = navigator.userAgent;
        if (s.match(/iPhone/i) || s.match(/iPod/i) || s.match(/webOS/i) || s.match(/BlackBerry/i) || (s.match(/Windows/i) && s.match(/Phone/i)) || (s.match(/Android/i) && s.match(/Mobile/i))) {
            return true;
        }
        return false;
    }

    var sf = {
        pause: function() {
            ready = false;
            helper.audioManager.audio.pause();
        },
        play: function() {
            ready = true;
            animate();
            helper.audioManager.audio.play();
        }
    };

    // DAT-GUI
    var controls = new function() {
        this.playing = ready || true;
        this.ambientColor = op.ambientColor;
        this.directionalLightColor = op.directionalLightColor;
    };
    var gui = new dat.GUI();
    var controlsCamera = gui.addFolder('Camera');
    controlsCamera.add(camera.position, 'x', -100, 100).listen();
    controlsCamera.add(camera.position, 'y', -100, 100).listen();
    controlsCamera.add(camera.position, 'z', -100, 100).listen();
    controlsCamera.add(camera, 'fov').listen();

    controlsCamera.open();

    gui.add(controls, 'playing').onChange(function(v) {
        v ? sf.play() : sf.pause();
    });
    gui.addColor(controls, 'ambientColor').onChange(function(c) {
        ambient.color.set(c);
    });
    gui.addColor(controls, 'directionalLightColor').onChange(function(c) {
        directionalLight.color.set(c);
    });

    var mmdData = new function() {
        this.ambientColor = op.ambientColor;
        this.directionalLightColor = op.directionalLightColor;
        this.modelFile = op.modelFile;
        this.vmdFiles = op.vmdFiles;
        this.audioFile = op.audioFile;
        this.cameraFiles = op.cameraFiles;
        this.callback = sf.play;
    };

    var gui2 = new dat.GUI();
    gui2.addColor(mmdData, 'ambientColor', mmdData.ambientColor);
    gui2.addColor(mmdData, 'directionalLightColor', mmdData.directionalLightColor);
    gui2.add(mmdData, 'modelFile', mmdData.modelFile);
    gui2.add(mmdData, 'vmdFiles', mmdData.vmdFiles);
    gui2.add(mmdData, 'audioFile', mmdData.audioFile, mmdData.audioFile.goodbyeTears);
    gui2.add(mmdData, 'cameraFiles', mmdData.cameraFiles);

    var mmdPlayBtn = document.createElement('li');
    mmdPlayBtn.innerHTML = 'Player MMD';
    mmdPlayBtn.style.textAlign = 'center';
    mmdPlayBtn.style.cursor = 'pointer';
    mmdPlayBtn.onclick = function() {
        sf.pause();
        helper.audioManager.audio.stop();
        helper.audioManager.audio.source.stop();
        mmdData.ambientColor = /miku9/gi.test(mmdData.modelFile) ? '#ffffff' : '#454545';
        remove('audio');
        remove('mesh');
        remove('listener');
        init(mmdData);
    };
    gui2.domElement.childNodes[1].appendChild(mmdPlayBtn);


    return scene;})();
    </script>
    <style type="text/css">
    #info {
        position: fixed;
        top: 0;
        left: 0;
        color: #999;
    }
    
    #info a {
        color: #999;
    }
    </style>
    <div id="info" style="position:fixed;top:0;left:0;">
        <a href="http://threejs.org/" target="_blank">three.js</a> - MMDLoader test
        <br> Copyright
        <br>
        <a href="http://www.moeol.com/forum.php?mod=viewthread&tid=19485&extra=&highlight=&page=1" target="_blank">Model Data</a> & <a href="http://www.nicovideo.jp/watch/sm13147122" target="_blank">Dance Data</a> <span id="model">loading...</span>
        <br>
        <a href="http://www.nicovideo.jp/watch/sm29236354" target="_blank">Camera Data</a> <span id="camera">loading</span>
        <br>
        <a href="http://www.nicovideo.jp/watch/sm29167672" target="_blank">Audio Data</a> <span id="audio">loading</span>
        <br>
        <a href="/" target="_blank">Go Index</a>
    </div>
</body>

</html>
